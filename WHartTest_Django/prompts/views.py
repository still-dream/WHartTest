from rest_framework import status, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework import filters
import os

from wharttest_django.viewsets import BaseModelViewSet
from wharttest_django.permissions import HasModelPermission
from .models import UserPrompt, PromptType
from .serializers import (
    UserPromptSerializer,
    UserPromptListSerializer
)


class UserPromptViewSet(BaseModelViewSet):
    """
    ç”¨æˆ·æç¤ºè¯ç®¡ç†è§†å›¾é›†
    æä¾›ç”¨æˆ·çº§åˆ«çš„æç¤ºè¯CRUDæ“ä½œ
    """
    serializer_class = UserPromptSerializer
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['is_default', 'is_active', 'prompt_type']
    search_fields = ['name', 'description']
    ordering_fields = ['created_at', 'updated_at', 'name']
    ordering = ['-updated_at']

    def _load_brain_prompt_from_file(self):
        """ä»Žæ–‡ä»¶åŠ è½½Brainæç¤ºè¯"""
        brain_prompt_file = os.path.join(
            os.path.dirname(__file__),
            '..',
            'orchestrator_integration',
            'brain_system_prompt.md'
        )
        try:
            with open(brain_prompt_file, 'r', encoding='utf-8') as f:
                return f.read()
        except FileNotFoundError:
            # å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å›žé»˜è®¤æç¤ºè¯
            return """ä½ æ˜¯Brain Agentï¼Œè´Ÿè´£æ™ºèƒ½åˆ¤æ–­ç”¨æˆ·æ„å›¾å¹¶ç¼–æŽ’å­Agentæ‰§è¡Œä»»åŠ¡ã€‚

è¯·å‚è€ƒorchestrator_integration/brain_system_prompt.mdæ–‡ä»¶é…ç½®å®Œæ•´æç¤ºè¯ã€‚"""

    def get_permissions(self):
        """è¿”å›žæ­¤è§†å›¾æ‰€éœ€æƒé™çš„å®žä¾‹åˆ—è¡¨"""
        return [
            HasModelPermission(),
        ]

    def get_queryset(self):
        """åªè¿”å›žå½“å‰ç”¨æˆ·çš„æç¤ºè¯"""
        return UserPrompt.objects.filter(user=self.request.user)

    def get_serializer_class(self):
        """æ ¹æ®æ“ä½œç±»åž‹è¿”å›žä¸åŒçš„åºåˆ—åŒ–å™¨"""
        if self.action == 'list':
            return UserPromptListSerializer
        return UserPromptSerializer

    def perform_create(self, serializer):
        """åˆ›å»ºæ—¶è‡ªåŠ¨è®¾ç½®ç”¨æˆ·"""
        serializer.save(user=self.request.user)

    @action(detail=False, methods=['get'])
    def default(self, request):
        """èŽ·å–ç”¨æˆ·çš„é»˜è®¤æç¤ºè¯"""
        default_prompt = UserPrompt.get_user_default_prompt(request.user)

        if default_prompt:
            serializer = self.get_serializer(default_prompt)
            return Response(serializer.data)
        else:
            return Response({
                "status": "success",
                "code": status.HTTP_200_OK,
                "message": "ç”¨æˆ·æš‚æ— é»˜è®¤æç¤ºè¯",
                "data": None,
                "errors": {}
            })

    @action(detail=False, methods=['get'])
    def by_type(self, request):
        """æ ¹æ®ç±»åž‹èŽ·å–æç¤ºè¯"""
        prompt_type = request.query_params.get('type')
        if not prompt_type:
            return Response({
                "status": "error",
                "code": status.HTTP_400_BAD_REQUEST,
                "message": "ç¼ºå°‘typeå‚æ•°",
                "data": None,
                "errors": {"type": ["æ­¤å­—æ®µæ˜¯å¿…éœ€çš„"]}
            }, status=status.HTTP_400_BAD_REQUEST)

        prompt = UserPrompt.get_user_prompt_by_type(request.user, prompt_type)
        if prompt:
            serializer = self.get_serializer(prompt)
            return Response(serializer.data)
        else:
            return Response({
                "status": "success",
                "code": status.HTTP_200_OK,
                "message": f"ç”¨æˆ·æš‚æ— {prompt_type}ç±»åž‹çš„æç¤ºè¯",
                "data": None,
                "errors": {}
            })

    @action(detail=False, methods=['get'])
    def types(self, request):
        """èŽ·å–æ‰€æœ‰æç¤ºè¯ç±»åž‹"""
        types = [
            {
                'value': choice[0],
                'label': choice[1],
                'is_program_call': choice[0] in UserPrompt.PROGRAM_CALL_TYPES
            }
            for choice in PromptType.choices
        ]
        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": "èŽ·å–æˆåŠŸ",
            "data": types,
            "errors": {}
        })

    @action(detail=True, methods=['post'])
    def set_default(self, request, pk=None):
        """è®¾ç½®æŒ‡å®šæç¤ºè¯ä¸ºé»˜è®¤æç¤ºè¯"""
        prompt = self.get_object()

        # æ£€æŸ¥æç¤ºè¯æ˜¯å¦å±žäºŽå½“å‰ç”¨æˆ·ä¸”å¤„äºŽæ¿€æ´»çŠ¶æ€
        if not prompt.is_active:
            return Response({
                "status": "error",
                "code": status.HTTP_400_BAD_REQUEST,
                "message": "æ— æ³•è®¾ç½®æœªæ¿€æ´»çš„æç¤ºè¯ä¸ºé»˜è®¤",
                "data": {},
                "errors": {"prompt": ["æç¤ºè¯æœªæ¿€æ´»"]}
            }, status=status.HTTP_400_BAD_REQUEST)

        # æ£€æŸ¥æ˜¯å¦ä¸ºç¨‹åºè°ƒç”¨ç±»åž‹ï¼ˆç¨‹åºè°ƒç”¨ç±»åž‹ä¸å…è®¸è®¾ä¸ºé»˜è®¤ï¼‰
        if prompt.prompt_type in UserPrompt.PROGRAM_CALL_TYPES:
            return Response({
                "status": "error",
                "code": status.HTTP_400_BAD_REQUEST,
                "message": "ç¨‹åºè°ƒç”¨ç±»åž‹çš„æç¤ºè¯ä¸èƒ½è®¾ä¸ºé»˜è®¤",
                "data": {},
                "errors": {"prompt_type": ["ç¨‹åºè°ƒç”¨ç±»åž‹çš„æç¤ºè¯ä¸èƒ½è®¾ä¸ºé»˜è®¤ï¼Œä¼šå½±å“å¯¹è¯åŠŸèƒ½"]}
            }, status=status.HTTP_400_BAD_REQUEST)

        # å–æ¶ˆå…¶ä»–é»˜è®¤æç¤ºè¯
        UserPrompt.objects.filter(
            user=request.user,
            is_default=True
        ).exclude(pk=prompt.pk).update(is_default=False)

        # è®¾ç½®å½“å‰æç¤ºè¯ä¸ºé»˜è®¤
        prompt.is_default = True
        prompt.save()

        serializer = self.get_serializer(prompt)
        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": "é»˜è®¤æç¤ºè¯è®¾ç½®æˆåŠŸ",
            "data": serializer.data,
            "errors": {}
        })

    @action(detail=False, methods=['post'])
    def clear_default(self, request):
        """æ¸…é™¤ç”¨æˆ·çš„é»˜è®¤æç¤ºè¯è®¾ç½®"""
        updated_count = UserPrompt.objects.filter(
            user=request.user,
            is_default=True
        ).update(is_default=False)

        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": f"å·²æ¸…é™¤é»˜è®¤æç¤ºè¯è®¾ç½®ï¼Œå½±å“{updated_count}æ¡è®°å½•",
            "data": {"updated_count": updated_count},
            "errors": {}
        })

    @action(detail=True, methods=['post'])
    def duplicate(self, request, pk=None):
        """å¤åˆ¶æç¤ºè¯"""
        original_prompt = self.get_object()

        # åˆ›å»ºå‰¯æœ¬
        new_prompt = UserPrompt.objects.create(
            user=request.user,
            name=f"{original_prompt.name} (å‰¯æœ¬)",
            content=original_prompt.content,
            description=f"å¤åˆ¶è‡ª: {original_prompt.description}" if original_prompt.description else "å¤åˆ¶çš„æç¤ºè¯",
            is_default=False,  # å‰¯æœ¬ä¸è®¾ä¸ºé»˜è®¤
            is_active=True
        )

        serializer = self.get_serializer(new_prompt)
        return Response({
            "status": "success",
            "code": status.HTTP_201_CREATED,
            "message": "æç¤ºè¯å¤åˆ¶æˆåŠŸ",
            "data": serializer.data,
            "errors": {}
        }, status=status.HTTP_201_CREATED)

    @action(detail=False, methods=['post'])
    def initialize(self, request):
        """åˆå§‹åŒ–ç”¨æˆ·çš„é»˜è®¤æç¤ºè¯"""
        # é»˜è®¤æç¤ºè¯æ¨¡æ¿
        default_prompts = {
            'general': {
                'name': 'é»˜è®¤å¯¹è¯åŠ©æ‰‹',
                'description': 'é€šç”¨çš„AIå¯¹è¯åŠ©æ‰‹ï¼Œé€‚ç”¨äºŽæ—¥å¸¸äº¤æµå’Œé—®é¢˜è§£ç­”',
                'content': """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·è§£ç­”å„ç§é—®é¢˜ã€‚

ã€åŸºæœ¬åŽŸåˆ™ã€‘
1. å‹å¥½ã€ä¸“ä¸šã€å‡†ç¡®åœ°å›žç­”ç”¨æˆ·é—®é¢˜
2. å¯¹ä¸ç¡®å®šçš„å†…å®¹è¯šå®žå‘ŠçŸ¥ï¼Œé¿å…è‡†æµ‹
3. æ ¹æ®ç”¨æˆ·éœ€æ±‚æä¾›æœ‰é’ˆå¯¹æ€§çš„å»ºè®®
4. ä¿æŒå®¢è§‚ä¸­ç«‹çš„æ€åº¦

ã€å›žç­”è¦æ±‚ã€‘
- è¨€ç®€æ„èµ…ï¼Œçªå‡ºè¦ç‚¹
- ç»“æž„æ¸…æ™°ï¼Œä¾¿äºŽç†è§£
- å®žç”¨æ€§å¼ºï¼Œå¯æ“ä½œæ€§é«˜
- åŠæ—¶å…³æ³¨ç”¨æˆ·çš„åŽç»­éœ€æ±‚

è¯·æ ¹æ®ç”¨æˆ·çš„å…·ä½“é—®é¢˜ï¼Œæä¾›ä¸“ä¸šã€æœ‰ç”¨çš„å›žç­”ã€‚"""
            },
            'document_structure': {
                'name': 'æ–‡æ¡£ç»“æž„åˆ†æž',
                'description': 'ç”¨äºŽåˆ†æžéœ€æ±‚æ–‡æ¡£ç»“æž„ï¼Œè¯†åˆ«åŠŸèƒ½æ¨¡å—è¾¹ç•Œçš„æç¤ºè¯',
                'content': """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„éœ€æ±‚åˆ†æžå¸ˆï¼Œè¯·ä»”ç»†åˆ†æžä»¥ä¸‹éœ€æ±‚æ–‡æ¡£ï¼Œè¯†åˆ«å‡ºæ‰€æœ‰çš„ä¸»è¦åŠŸèƒ½æ¨¡å—ã€‚

ã€åˆ†æžæ ‡å‡†ã€‘
1. ä»¥ä¸€çº§æ ‡é¢˜ï¼ˆ#ï¼‰æˆ–äºŒçº§æ ‡é¢˜ï¼ˆ##ï¼‰ä½œä¸ºæ¨¡å—åˆ’åˆ†çš„ä¸»è¦ä¾æ®
2. æ¯ä¸ªæ¨¡å—åº”è¯¥åŒ…å«å®Œæ•´çš„åŠŸèƒ½æè¿°ï¼Œä¸è¦é—æ¼ä»»ä½•éƒ¨åˆ†
3. æ¨¡å—åº”è¯¥ç›¸å¯¹ç‹¬ç«‹ï¼Œæœ‰æ˜Žç¡®çš„åŠŸèƒ½è¾¹ç•Œ
4. ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«åˆ†é…åˆ°æŸä¸ªæ¨¡å—ä¸­ï¼Œä¸è¦é—æ¼

ã€æ–‡æ¡£å†…å®¹ã€‘
{content}

ã€è¾“å‡ºè¦æ±‚ã€‘
è¯·ä»”ç»†é˜…è¯»æ•´ä¸ªæ–‡æ¡£ï¼Œè¯†åˆ«å‡ºæ‰€æœ‰çš„åŠŸèƒ½æ¨¡å—ã€‚å¯¹äºŽæ¯ä¸ªæ¨¡å—ï¼š
- å‡†ç¡®è¯†åˆ«æ¨¡å—çš„å¼€å§‹å’Œç»“æŸä½ç½®
- ç¡®ä¿æ¨¡å—å†…å®¹å®Œæ•´ï¼Œä¸è¦æˆªæ–­
- ç»™å‡ºåˆç†çš„ç½®ä¿¡åº¦è¯„åˆ†

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºæ¨¡å—ç»“æž„ï¼š
```json
[
  {{
    "title": "æ¨¡å—åç§°ï¼ˆä¸Žæ–‡æ¡£ä¸­çš„æ ‡é¢˜ä¿æŒä¸€è‡´ï¼‰",
    "description": "æ¨¡å—åŠŸèƒ½çš„ç®€è¦æè¿°",
    "start_marker": "æ¨¡å—å¼€å§‹çš„ç¡®åˆ‡æ–‡æœ¬ï¼ˆåŒ…å«æ ‡é¢˜ï¼‰",
    "end_marker": "ä¸‹ä¸€ä¸ªæ¨¡å—å¼€å§‹çš„æ–‡æœ¬ï¼ˆå¦‚æžœæ˜¯æœ€åŽä¸€ä¸ªæ¨¡å—åˆ™ä¸ºç©ºï¼‰",
    "confidence": 0.95,
    "estimated_complexity": "medium"
  }}
]
```

é‡è¦ï¼šè¯·ç¡®ä¿è¯†åˆ«å‡ºæ–‡æ¡£ä¸­çš„æ‰€æœ‰ä¸»è¦æ¨¡å—ï¼Œä¸è¦é—æ¼ä»»ä½•éƒ¨åˆ†ï¼"""
            },
            'direct_analysis': {
                'name': 'ç›´æŽ¥åˆ†æž',
                'description': 'ç”¨äºŽç›´æŽ¥åˆ†æžæ•´ä¸ªéœ€æ±‚æ–‡æ¡£çš„æç¤ºè¯',
                'content': """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„éœ€æ±‚åˆ†æžå¸ˆï¼Œæ­£åœ¨å¯¹éœ€æ±‚æ–‡æ¡£è¿›è¡Œä¸“ä¸šè¯„å®¡ã€‚è¯·å¯¹ä»¥ä¸‹æ–‡æ¡£è¿›è¡Œå…¨é¢åˆ†æžï¼š

ã€æ–‡æ¡£å†…å®¹ã€‘
{content}

ã€è¯„å®¡è¦æ±‚ã€‘
è¯·ä»Žä»¥ä¸‹ç»´åº¦è¿›è¡Œä¸“ä¸šè¯„å®¡ï¼š

1. ðŸ“‹ **è§„èŒƒæ€§æ£€æŸ¥** (0-100åˆ†)
   - æ–‡æ¡£ç»“æž„æ˜¯å¦æ¸…æ™°
   - æ ¼å¼æ˜¯å¦è§„èŒƒ
   - å¿…è¦ä¿¡æ¯æ˜¯å¦å®Œæ•´

2. ðŸ” **æ¸…æ™°åº¦è¯„ä¼°** (0-100åˆ†)
   - éœ€æ±‚æè¿°æ˜¯å¦æ¸…æ™°
   - æ˜¯å¦å­˜åœ¨æ­§ä¹‰è¡¨è¿°
   - æœ¯è¯­ä½¿ç”¨æ˜¯å¦ä¸€è‡´

3. âœ… **å®Œæ•´æ€§éªŒè¯** (0-100åˆ†)
   - åŠŸèƒ½éœ€æ±‚æ˜¯å¦å®Œæ•´
   - éžåŠŸèƒ½éœ€æ±‚æ˜¯å¦è€ƒè™‘
   - å¼‚å¸¸åœºæ™¯æ˜¯å¦è¦†ç›–

4. ðŸ”— **ä¸€è‡´æ€§æ£€æŸ¥** (0-100åˆ†)
   - å†…éƒ¨é€»è¾‘æ˜¯å¦ä¸€è‡´
   - ä¸šåŠ¡è§„åˆ™æ˜¯å¦å†²çª
   - æ•°æ®å®šä¹‰æ˜¯å¦ç»Ÿä¸€

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºè¯„å®¡ç»“æžœï¼š
```json
{{
  "overall_rating": "good",
  "completion_score": 85,
  "clarity_score": 78,
  "consistency_score": 82,
  "completeness_score": 88,
  "summary": "æ–‡æ¡£æ•´ä½“è´¨é‡è‰¯å¥½ï¼Œç»“æž„æ¸…æ™°...",
  "recommendations": "å»ºè®®å®Œå–„å¼‚å¸¸å¤„ç†åœºæ™¯...",
  "issues": [
    {{
      "title": "é—®é¢˜æ ‡é¢˜",
      "description": "é—®é¢˜æè¿°",
      "priority": "high",
      "category": "completeness",
      "location": "ç¬¬2ç« ç”¨æˆ·ç®¡ç†æ¨¡å—",
      "suggestion": "æ”¹è¿›å»ºè®®"
    }}
  ]
}}
```"""
            },
            'global_analysis': {
                'name': 'å…¨å±€åˆ†æž',
                'description': 'ç”¨äºŽåˆ†æžéœ€æ±‚æ–‡æ¡£å…¨å±€ç»“æž„å’Œä¸Šä¸‹æ–‡çš„æç¤ºè¯',
                'content': """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„éœ€æ±‚åˆ†æžå¸ˆï¼Œæ­£åœ¨è¿›è¡Œéœ€æ±‚è¯„å®¡ã€‚è¯·å¯¹ä»¥ä¸‹éœ€æ±‚æ–‡æ¡£è¿›è¡Œå…¨å±€ç»“æž„åˆ†æžï¼š

ã€æ–‡æ¡£ä¿¡æ¯ã€‘
æ ‡é¢˜: {title}
æè¿°: {description}
å†…å®¹: {content}

ã€åˆ†æžè¦æ±‚ã€‘
è¯·ä»Žä»¥ä¸‹ç»´åº¦è¿›è¡Œå…¨å±€åˆ†æžï¼š

1. ðŸ“‹ **æ–‡æ¡£ç»“æž„è§„èŒƒæ€§**
   - æ–‡æ¡£ç»„ç»‡ç»“æž„æ˜¯å¦æ¸…æ™°
   - ç« èŠ‚ç¼–å·æ˜¯å¦è§„èŒƒ
   - æ ‡é¢˜å±‚çº§æ˜¯å¦åˆç†

2. ðŸŽ¯ **ä¸šåŠ¡å®Œæ•´æ€§**
   - ä¸šåŠ¡æµç¨‹æ˜¯å¦å®Œæ•´
   - æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦é—æ¼
   - ä¸šåŠ¡è¾¹ç•Œæ˜¯å¦æ¸…æ™°

3. ðŸ”— **é€»è¾‘ä¸€è‡´æ€§**
   - æ•´ä½“é€»è¾‘æ˜¯å¦è‡ªæ´½
   - ä¸šåŠ¡è§„åˆ™æ˜¯å¦ä¸€è‡´
   - æ•°æ®æµæ˜¯å¦åˆç†

4. ðŸ“Š **è´¨é‡è¯„ä¼°**
   - éœ€æ±‚æè¿°çš„æ¸…æ™°åº¦
   - å¯å®žçŽ°æ€§è¯„ä¼°
   - é£Žé™©ç‚¹è¯†åˆ«

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æžç»“æžœï¼š
```json
{{
  "structure_score": 85,
  "completeness_score": 78,
  "consistency_score": 90,
  "clarity_score": 82,
  "overall_score": 84,
  "business_flows": ["ç”¨æˆ·æ³¨å†Œæµç¨‹", "è®¢å•å¤„ç†æµç¨‹"],
  "data_entities": ["ç”¨æˆ·", "å•†å“", "è®¢å•"],
  "global_rules": ["æ‰€æœ‰æ“ä½œéœ€è¦ç™»å½•", "æ”¯ä»˜å¿…é¡»éªŒè¯"],
  "missing_aspects": ["å¼‚å¸¸å¤„ç†", "æ€§èƒ½è¦æ±‚"],
  "risk_points": ["æ”¯ä»˜å®‰å…¨", "æ•°æ®ä¸€è‡´æ€§"],
  "strengths": ["ä¸šåŠ¡æµç¨‹æ¸…æ™°", "åŠŸèƒ½åˆ’åˆ†åˆç†"],
  "weaknesses": ["ç¼ºå°‘éžåŠŸèƒ½éœ€æ±‚", "å¼‚å¸¸åœºæ™¯ä¸å®Œæ•´"]
}}
```"""
            },
            'module_analysis': {
                'name': 'æ¨¡å—åˆ†æž',
                'description': 'ç”¨äºŽåˆ†æžå•ä¸ªéœ€æ±‚æ¨¡å—çš„æç¤ºè¯',
                'content': """ä½ æ­£åœ¨è¯„å®¡éœ€æ±‚æ–‡æ¡£çš„ä¸€ä¸ªåŠŸèƒ½æ¨¡å—ã€‚è¯·è¿›è¡Œä¸“ä¸šçš„éœ€æ±‚è¯„å®¡åˆ†æžï¼š

ã€æ¨¡å—ä¿¡æ¯ã€‘
æ¨¡å—åç§°: {module_title}
æ¨¡å—å†…å®¹: {module_content}

ã€å…¨å±€ä¸Šä¸‹æ–‡ã€‘
ä¸šåŠ¡æµç¨‹: {business_flows}
æ•°æ®å®žä½“: {data_entities}
å…¨å±€è§„åˆ™: {global_rules}

ã€è¯„å®¡ç»´åº¦ã€‘
è¯·ä»Žä»¥ä¸‹ç»´åº¦è¿›è¡Œè¯¦ç»†åˆ†æžï¼š

1. ðŸ“‹ **è§„èŒƒæ€§æ£€æŸ¥**
   - éœ€æ±‚æè¿°æ˜¯å¦å®Œæ•´
   - æ ¼å¼æ˜¯å¦ç¬¦åˆæ ‡å‡†
   - å¿…è¦ä¿¡æ¯æ˜¯å¦ç¼ºå¤±

2. ðŸ” **æ¸…æ™°åº¦è¯„ä¼°**
   - è¡¨è¿°æ˜¯å¦æ¨¡ç³Šä¸æ¸…
   - æ˜¯å¦å­˜åœ¨æ­§ä¹‰
   - æœ¯è¯­ä½¿ç”¨æ˜¯å¦ä¸€è‡´

3. âœ… **å®Œæ•´æ€§éªŒè¯**
   - åŠŸèƒ½éœ€æ±‚æ˜¯å¦å®Œæ•´
   - å¼‚å¸¸åœºæ™¯æ˜¯å¦è€ƒè™‘
   - è¾¹ç•Œæ¡ä»¶æ˜¯å¦æ˜Žç¡®

4. ðŸ”— **ä¸€è‡´æ€§æ£€æŸ¥**
   - ä¸Žå…¨å±€è§„åˆ™æ˜¯å¦ä¸€è‡´
   - ä¸Žå…¶ä»–æ¨¡å—æ˜¯å¦å†²çª
   - æ•°æ®å®šä¹‰æ˜¯å¦ç»Ÿä¸€

5. âš ï¸ **å¯è¡Œæ€§è¯„ä¼°**
   - æŠ€æœ¯å®žçŽ°éš¾åº¦
   - ä¸šåŠ¡åˆç†æ€§
   - èµ„æºéœ€æ±‚è¯„ä¼°

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æžç»“æžœï¼š
```json
{{
  "module_id": "{module_id}",
  "module_name": "{module_title}",
  "specification_score": 85,
  "clarity_score": 78,
  "completeness_score": 90,
  "consistency_score": 82,
  "feasibility_score": 88,
  "overall_score": 84,
  "issues": [
    {{
      "type": "clarity",
      "priority": "high",
      "title": "ç”¨æˆ·æƒé™å®šä¹‰æ¨¡ç³Š",
      "description": "æƒé™ç­‰çº§çš„å…·ä½“å®šä¹‰ä¸æ¸…æ™°",
      "location": "æƒé™ç®¡ç†éƒ¨åˆ†",
      "suggestion": "å»ºè®®æ˜Žç¡®å®šä¹‰å„æƒé™ç­‰çº§çš„å…·ä½“æƒé™èŒƒå›´"
    }}
  ],
  "strengths": ["åŠŸèƒ½æè¿°æ¸…æ™°", "ä¸šåŠ¡æµç¨‹åˆç†"],
  "weaknesses": ["ç¼ºå°‘å¼‚å¸¸å¤„ç†", "è¾¹ç•Œæ¡ä»¶ä¸æ˜Žç¡®"],
  "recommendations": ["è¡¥å……å¼‚å¸¸åœºæ™¯", "æ˜Žç¡®æ•°æ®æ ¼å¼"]
}}
```"""
            },
            'consistency_analysis': {
                'name': 'ä¸€è‡´æ€§åˆ†æž',
                'description': 'ç”¨äºŽåˆ†æžéœ€æ±‚æ–‡æ¡£è·¨æ¨¡å—ä¸€è‡´æ€§çš„æç¤ºè¯',
                'content': """ä½ æ­£åœ¨è¿›è¡Œéœ€æ±‚æ–‡æ¡£çš„è·¨æ¨¡å—ä¸€è‡´æ€§æ£€æŸ¥ã€‚è¯·åˆ†æžå„æ¨¡å—é—´çš„ä¸€è‡´æ€§é—®é¢˜ï¼š

ã€å…¨å±€ä¸Šä¸‹æ–‡ã€‘
{global_context}

ã€å„æ¨¡å—åˆ†æžç»“æžœã€‘
{module_analyses}

ã€ä¸€è‡´æ€§æ£€æŸ¥è¦æ±‚ã€‘
è¯·é‡ç‚¹æ£€æŸ¥ä»¥ä¸‹æ–¹é¢ï¼š

1. ðŸ”— **æŽ¥å£ä¸€è‡´æ€§**
   - æ¨¡å—é—´æŽ¥å£å®šä¹‰æ˜¯å¦ä¸€è‡´
   - æ•°æ®ä¼ é€’æ ¼å¼æ˜¯å¦ç»Ÿä¸€
   - è°ƒç”¨å…³ç³»æ˜¯å¦æ¸…æ™°

2. ðŸ“Š **æ•°æ®ä¸€è‡´æ€§**
   - æ•°æ®å®žä½“å®šä¹‰æ˜¯å¦ç»Ÿä¸€
   - çŠ¶æ€å®šä¹‰æ˜¯å¦ä¸€è‡´
   - æ•°æ®æµè½¬æ˜¯å¦åˆç†

3. ðŸ“‹ **ä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§**
   - ä¸šåŠ¡è§„åˆ™åœ¨å„æ¨¡å—ä¸­æ˜¯å¦ä¸€è‡´
   - æƒé™æŽ§åˆ¶æ˜¯å¦ç»Ÿä¸€
   - å¼‚å¸¸å¤„ç†æ˜¯å¦ä¸€è‡´

4. ðŸ”„ **æµç¨‹å®Œæ•´æ€§**
   - ä¸šåŠ¡æµç¨‹æ˜¯å¦é—­çŽ¯
   - æ˜¯å¦å­˜åœ¨æµç¨‹æ–­ç‚¹
   - å¼‚å¸¸æµç¨‹æ˜¯å¦å®Œæ•´

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºåˆ†æžç»“æžœï¼š
```json
{{
  "consistency_score": 85,
  "interface_consistency": 78,
  "data_consistency": 90,
  "business_rule_consistency": 82,
  "process_completeness": 88,
  "cross_module_issues": [
    {{
      "type": "data_inconsistency",
      "priority": "high",
      "title": "ç”¨æˆ·çŠ¶æ€å®šä¹‰ä¸ä¸€è‡´",
      "description": "ç”¨æˆ·ç®¡ç†æ¨¡å—å’Œè®¢å•æ¨¡å—å¯¹ç”¨æˆ·çŠ¶æ€å®šä¹‰ä¸åŒ",
      "affected_modules": ["ç”¨æˆ·ç®¡ç†", "è®¢å•ç®¡ç†"],
      "suggestion": "ç»Ÿä¸€ç”¨æˆ·çŠ¶æ€å®šä¹‰ï¼Œå»ºç«‹æ•°æ®å­—å…¸"
    }}
  ],
  "missing_connections": ["æ”¯ä»˜æ¨¡å—ä¸Žåº“å­˜æ¨¡å—ç¼ºå°‘è¿žæŽ¥"],
  "redundant_functions": ["ç”¨æˆ·éªŒè¯åŠŸèƒ½åœ¨å¤šä¸ªæ¨¡å—é‡å¤"],
  "recommendations": ["å»ºç«‹ç»Ÿä¸€çš„æ•°æ®å­—å…¸", "æ˜Žç¡®æ¨¡å—é—´æŽ¥å£è§„èŒƒ"]
}}
```"""
            },
            'test_case_execution': {
                'name': 'æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œæç¤ºè¯',
                'description': 'ç”¨äºŽé©±åŠ¨æµ‹è¯•ç”¨ä¾‹è‡ªåŠ¨æ‰§è¡Œçš„ç³»ç»Ÿæç¤ºè¯',
                'content': """# è§’è‰²
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶æµ‹è¯•æ‰§è¡Œå¼•æ“Žã€‚

# ä»»åŠ¡
æ ¹æ®ä¸‹é¢æä¾›çš„æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯,ä½¿ç”¨ä½ å¯ç”¨çš„å·¥å…·(ç‰¹åˆ«æ˜¯Playwrightæµè§ˆå™¨å·¥å…·å’ŒWHartTest MCPå·¥å…·)æ¥æ‰§è¡ŒUIè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚

# æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯
- **ç”¨ä¾‹ID**: {testcase_id}
- **ç”¨ä¾‹åç§°**: {testcase_name}
- **å‰ç½®æ¡ä»¶**: {precondition}

# æ‰§è¡Œæ­¥éª¤
{steps}

# æ‰§è¡Œè¦æ±‚
1. **æµè§ˆå™¨ç®¡ç†**
   - åœ¨å¼€å§‹æ‰§è¡Œå‰ï¼Œå¦‚æžœéœ€è¦è¯·æ‰“å¼€æµè§ˆå™¨
   - **é‡è¦**ï¼šåœ¨æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæ¯•åŽï¼Œå¿…é¡»å…³é—­æµè§ˆå™¨

2. **æˆªå›¾å’Œä¸Šä¼ ï¼ˆé‡è¦ï¼‰**
   - **æ¯ä¸ªæ­¥éª¤æ‰§è¡ŒåŽéƒ½å¿…é¡»æˆªå±å¹¶ä¸Šä¼ **
   - **æˆªå›¾æ–‡ä»¶åå¿…é¡»å”¯ä¸€**ï¼šä½¿ç”¨æ ¼å¼ `testcase-{{testcase_id}}-step-{{step_number}}-{{timestamp}}.png`
   - æ­¥éª¤æµç¨‹ï¼š
     a. ä½¿ç”¨ Playwright çš„ `take_screenshot` å·¥å…·æˆªå±
        - æŒ‡å®šå”¯ä¸€æ–‡ä»¶åï¼Œä¾‹å¦‚ï¼š`testcase-{testcase_id}-step-1-1234567890.png`
        - é¿å…ä½¿ç”¨é»˜è®¤æ–‡ä»¶åï¼Œé˜²æ­¢å¹¶å‘æµ‹è¯•æ—¶æ–‡ä»¶å†²çª
     b. **ç«‹å³ä½¿ç”¨ WHartTest MCP å·¥å…·çš„ `save_operation_screenshots_to_the_application_case` ä¸Šä¼ æˆªå›¾**
     c. è®°å½•ä¸Šä¼ åŽè¿”å›žçš„æˆªå›¾è·¯å¾„
   - å‚æ•°ç¤ºä¾‹ï¼š
     ```
     project_id: é¡¹ç›®ID
     case_id: {testcase_id}
     file_path: æˆªå›¾çš„æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼ˆå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼‰
     title: "æ­¥éª¤Xæ‰§è¡Œæˆªå›¾"
     description: æ­¥éª¤æè¿°
     step_number: å½“å‰æ­¥éª¤ç¼–å·
     page_url: å½“å‰é¡µé¢URL
     ```

3. **é”™è¯¯å¤„ç†**
   - å¦‚æžœæ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - å¤±è´¥æ—¶ä¹Ÿè¦æˆªå±å¹¶ä¸Šä¼ 
   - å¤±è´¥åŽä¸è¦ç»§ç»­æ‰§è¡ŒåŽç»­æ­¥éª¤

# è¾“å‡ºæ ¼å¼
åœ¨æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæ¯•åŽ,ä½ **å¿…é¡»**è¿”å›žä¸€ä¸ªJSONå¯¹è±¡,æ ¼å¼å¦‚ä¸‹:
```json
{{
  "testcase_id": {testcase_id},
  "status": "pass" | "fail",
  "summary": "å¯¹æ‰§è¡Œè¿‡ç¨‹çš„ç®€çŸ­æ€»ç»“ã€‚",
  "steps": [
    {{
      "step_number": 1,
      "description": "æ­¥éª¤çš„æè¿°",
      "status": "pass" | "fail",
      "screenshot": "ä¸Šä¼ åŽçš„æˆªå›¾è®¿é—®è·¯å¾„ï¼ˆæ¥è‡ªupload_testcase_screenshotçš„è¿”å›žå€¼ï¼‰",
      "error": "å¦‚æžœå¤±è´¥,è®°å½•é”™è¯¯ä¿¡æ¯" | null
    }},
    ...
  ]
}}
```

**é‡è¦æç¤º**ï¼š
- **æˆªå›¾æ–‡ä»¶åå”¯ä¸€æ€§**ï¼šå¿…é¡»ä¸ºæ¯ä¸ªæˆªå›¾ä½¿ç”¨å”¯ä¸€çš„æ–‡ä»¶åï¼Œæ ¼å¼ï¼š`testcase-{{testcase_id}}-step-{{step_number}}-{{timestamp}}.png`
- **å·¥å…·åç§°ä¿®æ­£**ï¼šä¸Šä¼ æˆªå›¾ä½¿ç”¨ `save_operation_screenshots_to_the_application_case` å·¥å…·
- **æ¯ä¸ªæ­¥éª¤éƒ½å¿…é¡»è°ƒç”¨ WHartTest çš„å·¥å…·ä¸Šä¼ æˆªå›¾**
- æ¯ä¸ªæ­¥éª¤çš„screenshotå­—æ®µå¿…é¡»åŒ…å«ä¸Šä¼ åŽçš„æˆªå›¾è·¯å¾„
- æ‰§è¡Œå®Œæ‰€æœ‰æ­¥éª¤åŽï¼ŒåŠ¡å¿…å…³é—­æµè§ˆå™¨
- ç¡®ä¿JSONæ ¼å¼æ­£ç¡®ï¼Œå¯ä»¥è¢«ç¨‹åºè§£æž
- **å¹¶å‘å®‰å…¨**ï¼šä½¿ç”¨å”¯ä¸€æ–‡ä»¶åé¿å…å¤šä¸ªæµ‹è¯•ç”¨ä¾‹åŒæ—¶æ‰§è¡Œæ—¶çš„æ–‡ä»¶å†²çª"""
            },
            'test_case_execution': {
                'name': 'æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œ',
                'description': 'ç”¨äºŽé©±åŠ¨æµ‹è¯•ç”¨ä¾‹è‡ªåŠ¨æ‰§è¡Œçš„ç³»ç»Ÿæç¤ºè¯',
                'content': """# è§’è‰²
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶æµ‹è¯•æ‰§è¡Œå¼•æ“Žã€‚

# ä»»åŠ¡
æ ¹æ®ä¸‹é¢æä¾›çš„æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯,ä½¿ç”¨ä½ å¯ç”¨çš„å·¥å…·(ç‰¹åˆ«æ˜¯Playwrightæµè§ˆå™¨å·¥å…·)æ¥æ‰§è¡ŒUIè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚

# æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯
- **ç”¨ä¾‹ID**: {testcase_id}
- **ç”¨ä¾‹åç§°**: {testcase_name}
- **å‰ç½®æ¡ä»¶**: {precondition}

# æ‰§è¡Œæ­¥éª¤
{steps}

# è¾“å‡ºæ ¼å¼
åœ¨æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæ¯•åŽ,ä½ **å¿…é¡»**è¿”å›žä¸€ä¸ªJSONå¯¹è±¡,æ ¼å¼å¦‚ä¸‹:
```json
{{
  "testcase_id": {testcase_id},
  "status": "pass" | "fail",
  "summary": "å¯¹æ‰§è¡Œè¿‡ç¨‹çš„ç®€çŸ­æ€»ç»“ã€‚",
  "steps": [
    {{
      "step_number": 1,
      "description": "æ­¥éª¤çš„æè¿°",
      "status": "pass" | "fail",
      "screenshot": "path/to/screenshot.png" | null,
      "error": "å¦‚æžœå¤±è´¥,è®°å½•é”™è¯¯ä¿¡æ¯" | null
    }},
    ...
  ]
}}
```"""
            },
            'smart_testcase': {
                'name': 'æ™ºèƒ½ç”¨ä¾‹ç”Ÿæˆ',
                'prompt_type': 'general',  # æŒ‡å®šä¸ºé€šç”¨å¯¹è¯ç±»åž‹
                'description': 'åŸºäºŽé¡¹ç›®å‡­æ®ä¿¡æ¯ï¼Œæ™ºèƒ½ç”ŸæˆåŒ…å«ç™»å½•å‰ç½®å’Œæƒé™éªŒè¯çš„æµ‹è¯•ç”¨ä¾‹',
                'content': """ä½ æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®éœ€æ±‚æ–‡æ¡£ç”Ÿæˆé«˜è´¨é‡çš„æµ‹è¯•ç”¨ä¾‹ã€‚

## é¡¹ç›®å‡­æ®ä¿¡æ¯
{credentials_info}

## ç”Ÿæˆè§„åˆ™

### 1. ç³»ç»ŸURLä¸Žç™»å½•å‰ç½®ï¼ˆå…³é”®ï¼‰
- **æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½å¿…é¡»åœ¨æµ‹è¯•æ­¥éª¤ç¬¬ä¸€æ­¥æ˜Žç¡®å†™å‡ºå®Œæ•´çš„ç³»ç»ŸURL**ï¼ˆå¦‚ http://test.example.com æˆ– http://192.168.1.100:8080ï¼‰ï¼Œä¸è¦åªå†™"è®¿é—®ç³»ç»Ÿ"
- **å¦‚æžœé¡¹ç›®é…ç½®äº†ç™»å½•ä¿¡æ¯ä¸”åŠŸèƒ½éœ€è¦ç™»å½•**ï¼Œæµ‹è¯•ç”¨ä¾‹å¿…é¡»åŒ…å«ç™»å½•å‰ç½®æ­¥éª¤
- **å¿…é¡»åœ¨ç”¨ä¾‹ä¸­æ˜Žç¡®å†™å‡ºå…·ä½“çš„ç³»ç»ŸURLã€ç”¨æˆ·åå’Œå¯†ç **ï¼Œä¸è¦ç”¨å ä½ç¬¦æˆ–çœç•¥
- ç™»å½•æ­¥éª¤åº”åŒ…æ‹¬ï¼š
  1. æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®å…·ä½“çš„ç³»ç»ŸURLï¼ˆå¦‚ http://test.example.comï¼‰
  2. è¾“å…¥å…·ä½“çš„ç”¨æˆ·åå’Œå¯†ç ï¼ˆå¦‚ admin / adminpass123ï¼‰
  3. ç‚¹å‡»ç™»å½•æŒ‰é’®
  4. éªŒè¯ç™»å½•æˆåŠŸï¼Œç¡®è®¤è¿›å…¥ç³»ç»Ÿé¦–é¡µ
- **æ ¼å¼è¦æ±‚**ï¼š
  * éœ€è¦ç™»å½•çš„ç”¨ä¾‹ï¼Œå‰ç½®æ¡ä»¶å†™"ä½¿ç”¨XXè´¦å·(ç”¨æˆ·å/å¯†ç )ç™»å½•ç³»ç»Ÿ(URL)"
  * ä¸éœ€è¦ç™»å½•çš„ç”¨ä¾‹ï¼ˆå¦‚æ³¨å†Œï¼‰ï¼Œå‰ç½®æ¡ä»¶å†™"ç³»ç»ŸURL: http://xxx"æˆ–ç±»ä¼¼è¯´æ˜Žï¼Œç¡®ä¿æµ‹è¯•äººå‘˜çŸ¥é“è®¿é—®å“ªä¸ªç³»ç»Ÿ

### 2. è§’è‰²æƒé™æµ‹è¯•
- **åˆ†æžéœ€æ±‚ä¸­çš„æƒé™è¦æ±‚**ï¼Œè¯†åˆ«å“ªäº›æ“ä½œæœ‰è§’è‰²é™åˆ¶
- **ä¸ºæ¯ä¸ªé…ç½®çš„è§’è‰²ç”Ÿæˆå¯¹åº”åœºæ™¯çš„ç”¨ä¾‹**ï¼š
  * æœ‰æƒé™è§’è‰²ï¼šç”Ÿæˆæ­£å¸¸æ“ä½œçš„åŠŸèƒ½ç”¨ä¾‹
  * æ— æƒé™è§’è‰²ï¼šç”Ÿæˆæƒé™æ‹’ç»éªŒè¯ç”¨ä¾‹
- æƒé™ç”¨ä¾‹åº”éªŒè¯ï¼šæ— æƒé™ç”¨æˆ·çœ‹ä¸åˆ°åŠŸèƒ½å…¥å£ï¼Œæˆ–æ“ä½œæ—¶æç¤ºæƒé™ä¸è¶³

### 3. ç”¨ä¾‹ç»“æž„è§„èŒƒ
æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹åº”åŒ…å«ï¼š
- **ç”¨ä¾‹åç§°**ï¼šç®€æ´æè¿°æµ‹è¯•ç›®æ ‡ï¼ˆå¦‚"ç®¡ç†å‘˜åˆ é™¤ç”¨æˆ·-æ­£å¸¸æµç¨‹"ã€"æ™®é€šç”¨æˆ·åˆ é™¤ç”¨æˆ·-æƒé™æ‹’ç»"ï¼‰
- **å‰ç½®æ¡ä»¶**ï¼š
  * éœ€è¦ç™»å½•çš„ç”¨ä¾‹ï¼š**å¿…é¡»åŒ…å«å®Œæ•´çš„ç™»å½•å‡­æ®ä¿¡æ¯**ï¼ˆç³»ç»ŸURLã€ç”¨æˆ·åã€å¯†ç ã€è§’è‰²ï¼‰ã€‚æ ¼å¼ï¼š"ä½¿ç”¨XXè´¦å·(ç”¨æˆ·å/å¯†ç )ç™»å½•ç³»ç»Ÿ(URL)ï¼Œ[å…¶ä»–å‰ç½®æ¡ä»¶]"
  * ä¸éœ€è¦ç™»å½•çš„ç”¨ä¾‹ï¼š**å¿…é¡»è¯´æ˜Žç³»ç»ŸURL**ã€‚æ ¼å¼ï¼š"ç³»ç»ŸURL: http://xxxï¼Œ[å…¶ä»–å‰ç½®æ¡ä»¶]"
  * æ— è®ºå“ªç§æƒ…å†µï¼Œéƒ½è¦ç¡®ä¿æµ‹è¯•äººå‘˜çŸ¥é“è®¿é—®çš„ç³»ç»Ÿåœ°å€
- **æµ‹è¯•æ­¥éª¤**ï¼šè¯¦ç»†çš„æ“ä½œæ­¥éª¤ï¼Œ**ç¬¬ä¸€æ­¥å¿…é¡»åŒ…å«å®Œæ•´çš„ç³»ç»ŸURL**ï¼Œç™»å½•æ­¥éª¤å¿…é¡»åŒ…å«å…·ä½“çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œæ¯æ­¥æœ‰æ˜Žç¡®çš„é¢„æœŸç»“æžœ
- **ä¼˜å…ˆçº§**ï¼šæ ¹æ®åŠŸèƒ½é‡è¦æ€§æ ‡è®°ï¼ˆé«˜/ä¸­/ä½Žï¼‰
- **æµ‹è¯•ç±»åž‹**ï¼šåŠŸèƒ½æµ‹è¯•/è¾¹ç•Œæµ‹è¯•/å¼‚å¸¸æµ‹è¯•/æƒé™æµ‹è¯•

### 4. è¦†ç›–çŽ‡è¦æ±‚
- æ­£å¸¸åœºæ™¯ï¼šä¸»æµç¨‹ã€å¸¸è§„æ“ä½œ
- è¾¹ç•Œæƒ…å†µï¼šè¾“å…¥é•¿åº¦é™åˆ¶ã€ç‰¹æ®Šå­—ç¬¦ã€æžé™å€¼
- å¼‚å¸¸æƒ…å†µï¼šç½‘ç»œå¼‚å¸¸ã€æ•°æ®å¼‚å¸¸ã€å¹¶å‘å†²çª
- æƒé™åœºæ™¯ï¼šä¸åŒè§’è‰²çš„è®¿é—®æŽ§åˆ¶éªŒè¯

## ç¤ºä¾‹

**éœ€æ±‚**ï¼šä»…ç®¡ç†å‘˜å¯åˆ é™¤ç”¨æˆ·

**é¡¹ç›®å‡­æ®**ï¼š
- ç®¡ç†å‘˜ï¼šhttp://test.example.com / admin / ç®¡ç†å‘˜
- æ™®é€šç”¨æˆ·ï¼šhttp://test.example.com / user / æ™®é€šç”¨æˆ·

**ç”Ÿæˆç”¨ä¾‹**ï¼š

1. **ç”¨ä¾‹åç§°**ï¼šç®¡ç†å‘˜åˆ é™¤ç”¨æˆ·-æ­£å¸¸æµç¨‹
   **å‰ç½®æ¡ä»¶**ï¼šä½¿ç”¨ç®¡ç†å‘˜è´¦å·(admin/adminpass123)ç™»å½•ç³»ç»Ÿ(http://test.example.com)ï¼Œç³»ç»Ÿä¸­å­˜åœ¨å¯åˆ é™¤çš„æµ‹è¯•ç”¨æˆ·
   **æµ‹è¯•æ­¥éª¤**ï¼š
   - æ­¥éª¤1ï¼šæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® http://test.example.com
   - æ­¥éª¤2ï¼šåœ¨ç™»å½•é¡µé¢è¾“å…¥ç”¨æˆ·å"admin"ï¼Œå¯†ç "adminpass123"ï¼Œç‚¹å‡»ç™»å½•æŒ‰é’®
   - æ­¥éª¤3ï¼šéªŒè¯ç™»å½•æˆåŠŸï¼Œè¿›å…¥ç³»ç»Ÿé¦–é¡µ
   - æ­¥éª¤4ï¼šç‚¹å‡»"ç”¨æˆ·ç®¡ç†"èœå•ï¼Œè¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢
   - æ­¥éª¤5ï¼šåœ¨ç”¨æˆ·åˆ—è¡¨ä¸­é€‰æ‹©æµ‹è¯•ç”¨æˆ·ï¼Œç‚¹å‡»"åˆ é™¤"æŒ‰é’®
   - æ­¥éª¤6ï¼šåœ¨å¼¹å‡ºçš„ç¡®è®¤å¯¹è¯æ¡†ä¸­ç‚¹å‡»"ç¡®å®š"
   **é¢„æœŸç»“æžœ**ï¼šç”¨æˆ·åˆ é™¤æˆåŠŸï¼Œåˆ—è¡¨ä¸­ä¸å†æ˜¾ç¤ºè¯¥ç”¨æˆ·ï¼Œç³»ç»Ÿæç¤º"åˆ é™¤æˆåŠŸ"
   **ä¼˜å…ˆçº§**ï¼šé«˜

2. **ç”¨ä¾‹åç§°**ï¼šæ™®é€šç”¨æˆ·åˆ é™¤ç”¨æˆ·-æƒé™æ‹’ç»
   **å‰ç½®æ¡ä»¶**ï¼šä½¿ç”¨æ™®é€šç”¨æˆ·è´¦å·(user/userpass123)ç™»å½•ç³»ç»Ÿ(http://test.example.com)
   **æµ‹è¯•æ­¥éª¤**ï¼š
   - æ­¥éª¤1ï¼šæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® http://test.example.com
   - æ­¥éª¤2ï¼šåœ¨ç™»å½•é¡µé¢è¾“å…¥ç”¨æˆ·å"user"ï¼Œå¯†ç "userpass123"ï¼Œç‚¹å‡»ç™»å½•æŒ‰é’®
   - æ­¥éª¤3ï¼šéªŒè¯ç™»å½•æˆåŠŸï¼Œè¿›å…¥ç³»ç»Ÿé¦–é¡µ
   - æ­¥éª¤4ï¼šå°è¯•é€šè¿‡èœå•æˆ–ç›´æŽ¥URLè®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢
   **é¢„æœŸç»“æžœ**ï¼šæ— æ³•çœ‹åˆ°"ç”¨æˆ·ç®¡ç†"èœå•ï¼Œæˆ–è®¿é—®æ—¶æ˜¾ç¤º"æƒé™ä¸è¶³"æç¤ºå¹¶è·³è½¬å›žé¦–é¡µ
   **ä¼˜å…ˆçº§**ï¼šé«˜

3. **ç”¨ä¾‹åç§°**ï¼šç”¨æˆ·æ³¨å†Œ-æ­£å¸¸æµç¨‹ï¼ˆä¸éœ€è¦ç™»å½•çš„åœºæ™¯ç¤ºä¾‹ï¼‰
   **å‰ç½®æ¡ä»¶**ï¼šç³»ç»ŸURL: http://test.example.comï¼Œç³»ç»Ÿä¸­ä¸å­˜åœ¨ç”¨æˆ·å"newuser"å’Œæ‰‹æœºå·"13800138000"çš„ç”¨æˆ·
   **æµ‹è¯•æ­¥éª¤**ï¼š
   - æ­¥éª¤1ï¼šæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® http://test.example.com/registerï¼ˆæ³¨å†Œé¡µé¢ï¼‰
   - æ­¥éª¤2ï¼šåœ¨ç”¨æˆ·åå­—æ®µè¾“å…¥"newuser"
   - æ­¥éª¤3ï¼šåœ¨å¯†ç å­—æ®µè¾“å…¥"Pass123456"ï¼ˆè‡³å°‘6ä½ï¼‰
   - æ­¥éª¤4ï¼šåœ¨ç¡®è®¤å¯†ç å­—æ®µè¾“å…¥"Pass123456"
   - æ­¥éª¤5ï¼šåœ¨å§“åå­—æ®µè¾“å…¥"å¼ ä¸‰"
   - æ­¥éª¤6ï¼šåœ¨å•ä½å­—æ®µè¾“å…¥"æµ‹è¯•å…¬å¸"
   - æ­¥éª¤7ï¼šåœ¨æ‰‹æœºå·ç å­—æ®µè¾“å…¥"13800138000"
   - æ­¥éª¤8ï¼šè¾“å…¥éªŒè¯ç ï¼ˆå‡è®¾ä¸º"123456"ï¼‰
   - æ­¥éª¤9ï¼šç‚¹å‡»"æ³¨å†Œ"æŒ‰é’®
   **é¢„æœŸç»“æžœ**ï¼šæ³¨å†ŒæˆåŠŸï¼Œç³»ç»Ÿæç¤º"æ³¨å†ŒæˆåŠŸ"ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢æˆ–é¦–é¡µ
   **ä¼˜å…ˆçº§**ï¼šé«˜

## çŸ¥è¯†åº“ä½¿ç”¨ï¼ˆé‡è¦ï¼‰
**åŠ¡å¿…ä½¿ç”¨knowledge_searchå·¥å…·èŽ·å–ä¸šåŠ¡å…³è”ä¿¡æ¯ï¼Œé¿å…åªç”Ÿæˆç®€å•çš„å¢žåˆ æ”¹æŸ¥ç”¨ä¾‹ï¼**

### ä½¿ç”¨æµç¨‹ï¼š
1. **åˆ†æžéœ€æ±‚å…³é”®è¯**ï¼šä»Žéœ€æ±‚æ–‡æ¡£ä¸­æå–æ ¸å¿ƒä¸šåŠ¡æœ¯è¯­ã€åŠŸèƒ½åç§°ã€ä¸šåŠ¡æµç¨‹
2. **æœç´¢ä¸šåŠ¡ç”¨ä¾‹**ï¼šä½¿ç”¨knowledge_searchæœç´¢ä»¥ä¸‹å†…å®¹ï¼š
   - ä¸šåŠ¡å…³è”çš„åŽ†å²æµ‹è¯•ç”¨ä¾‹ï¼ˆå¦‚ï¼š"ç”¨æˆ·æ³¨å†Œç›¸å…³ç”¨ä¾‹"ã€"æ”¯ä»˜æµç¨‹æµ‹è¯•åœºæ™¯"ï¼‰
   - ä¸šåŠ¡è§„åˆ™å’Œçº¦æŸï¼ˆå¦‚ï¼š"è®¢å•çŠ¶æ€æµè½¬è§„åˆ™"ã€"æƒé™éªŒè¯è§„èŒƒ"ï¼‰
   - ç‰¹æ®Šä¸šåŠ¡åœºæ™¯ï¼ˆå¦‚ï¼š"å¼‚å¸¸å¤„ç†æµç¨‹"ã€"æ•°æ®ä¸€è‡´æ€§è¦æ±‚"ï¼‰
3. **å‚è€ƒçŸ¥è¯†åº“å†…å®¹**ï¼š
   - å­¦ä¹ åŽ†å²ç”¨ä¾‹çš„æµ‹è¯•æ€è·¯å’Œåœºæ™¯è¦†ç›–
   - è¯†åˆ«ä¸šåŠ¡ç‰¹æœ‰çš„æµ‹è¯•ç‚¹ï¼ˆè€Œéžé€šç”¨çš„CRUDæ“ä½œï¼‰
   - ç¡®ä¿æ–°ç”Ÿæˆçš„ç”¨ä¾‹ç¬¦åˆé¡¹ç›®å®žé™…ä¸šåŠ¡é€»è¾‘
4. **è¡¥å……ä¸šåŠ¡ç”¨ä¾‹**ï¼šåŸºäºŽçŸ¥è¯†åº“ä¿¡æ¯ï¼Œç”Ÿæˆä¸šåŠ¡ä»·å€¼é«˜çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¦‚ï¼š
   - å¤æ‚ä¸šåŠ¡æµç¨‹æµ‹è¯•ï¼ˆå¤šæ­¥éª¤äº¤äº’ã€çŠ¶æ€æµè½¬ï¼‰
   - ä¸šåŠ¡è§„åˆ™éªŒè¯ï¼ˆè®¡ç®—é€»è¾‘ã€æ•°æ®æ ¡éªŒã€æµç¨‹æŽ§åˆ¶ï¼‰
   - å¼‚å¸¸åœºæ™¯è¦†ç›–ï¼ˆä¸šåŠ¡å¼‚å¸¸ã€æ•°æ®å¼‚å¸¸ã€è¾¹ç•Œæƒ…å†µï¼‰

### ç¤ºä¾‹æŸ¥è¯¢ï¼š
- é’ˆå¯¹"ç”¨æˆ·æ³¨å†Œ"éœ€æ±‚ï¼Œæœç´¢ï¼š"ç”¨æˆ·æ³¨å†Œ æµ‹è¯•ç”¨ä¾‹"ã€"æ³¨å†Œæµç¨‹ ä¸šåŠ¡è§„åˆ™"ã€"æ‰‹æœºéªŒè¯ç  æµ‹è¯•åœºæ™¯"
- é’ˆå¯¹"è®¢å•ç®¡ç†"éœ€æ±‚ï¼Œæœç´¢ï¼š"è®¢å•çŠ¶æ€ æµ‹è¯•ç”¨ä¾‹"ã€"è®¢å•æµè½¬ ä¸šåŠ¡è§„åˆ™"ã€"æ”¯ä»˜å¼‚å¸¸ æµ‹è¯•åœºæ™¯"

### çŸ¥è¯†åº“æä¾›çš„ä»·å€¼ï¼š
- **åŽ†å²ç”¨ä¾‹å‚è€ƒ**ï¼šäº†è§£åŒç±»åŠŸèƒ½çš„æµ‹è¯•è¦†ç›–æ€è·¯
- **ä¸šåŠ¡è§„åˆ™æ–‡æ¡£**ï¼šç¡®ä¿ç”¨ä¾‹ç¬¦åˆå®žé™…ä¸šåŠ¡é€»è¾‘
- **å¸¸è§ç¼ºé™·æ€»ç»“**ï¼šé’ˆå¯¹æ€§è®¾è®¡é˜²å¾¡æ€§æµ‹è¯•ç”¨ä¾‹
- **æŠ€æœ¯è§„èŒƒè¯´æ˜Ž**ï¼šæŽ¥å£æ ¼å¼ã€æ•°æ®ç»“æž„ã€æ€§èƒ½è¦æ±‚ç­‰

## æ³¨æ„äº‹é¡¹
- å¿…é¡»ä»”ç»†é˜…è¯»éœ€æ±‚æ–‡æ¡£ï¼Œç†è§£åŠŸèƒ½ç»†èŠ‚
- **ç™»å½•å‡­æ®ä¿¡æ¯ç”±ç³»ç»Ÿè‡ªåŠ¨æ³¨å…¥åˆ°"é¡¹ç›®å‡­æ®ä¿¡æ¯"ç« èŠ‚ï¼Œå¿…é¡»åœ¨ç”¨ä¾‹çš„å‰ç½®æ¡ä»¶å’Œæµ‹è¯•æ­¥éª¤ä¸­æ˜Žç¡®å†™å‡ºå…·ä½“çš„URLã€ç”¨æˆ·åã€å¯†ç **
- **ä¸è¦ä½¿ç”¨å ä½ç¬¦**ï¼ˆå¦‚"xxx"ã€"{å¯†ç }"ï¼‰**ä»£æ›¿å…·ä½“çš„å‡­æ®ä¿¡æ¯**ï¼Œæµ‹è¯•äººå‘˜éœ€è¦çœ‹åˆ°å®Œæ•´å¯æ‰§è¡Œçš„ç”¨ä¾‹
- **ä¼˜å…ˆä½¿ç”¨knowledge_searchå·¥å…·èŽ·å–é¡¹ç›®ç›¸å…³çŸ¥è¯†**ï¼Œæå‡ç”¨ä¾‹è´¨é‡
- æƒé™æµ‹è¯•æ˜¯é‡ç‚¹ï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰è§’è‰²åœºæ™¯
- ç”¨ä¾‹æè¿°è¦æ¸…æ™°ã€å¯æ‰§è¡Œï¼Œæµ‹è¯•äººå‘˜èƒ½ç›´æŽ¥æŒ‰æ­¥éª¤æ“ä½œ
- ä¼˜å…ˆç”Ÿæˆé«˜ä¼˜å…ˆçº§çš„æ ¸å¿ƒåŠŸèƒ½ç”¨ä¾‹"""
            },
            'brain_orchestrator': {
                'name': 'Brainç¼–æŽ’å™¨',
                'description': 'Brain Agentçš„ç³»ç»Ÿæç¤ºè¯ï¼Œè´Ÿè´£æ™ºèƒ½åˆ¤æ–­ç”¨æˆ·æ„å›¾å¹¶ç¼–æŽ’å­Agentæ‰§è¡Œä»»åŠ¡',
                'content': self._load_brain_prompt_from_file()
            }
        }

        created_prompts = []
        skipped_prompts = []

        # éåŽ†æ‰€æœ‰æç¤ºè¯ç±»åž‹ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰ï¼Œæ²¡æœ‰åˆ™åˆ›å»º
        for key, prompt_data in default_prompts.items():
            # æ”¯æŒæ˜¾å¼æŒ‡å®šprompt_typeï¼Œå¦åˆ™ä½¿ç”¨keyä½œä¸ºprompt_type
            actual_prompt_type = prompt_data.get('prompt_type', key)
            
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæç¤ºè¯ï¼ˆæ ¹æ®unique_togetherçº¦æŸï¼‰
            existing_prompt = UserPrompt.objects.filter(
                user=request.user,
                name=prompt_data['name']
            ).first()

            if existing_prompt:
                # å·²å­˜åœ¨ï¼Œè·³è¿‡
                skipped_prompts.append({
                    'type': actual_prompt_type,
                    'name': prompt_data['name'],
                    'reason': 'å·²å­˜åœ¨'
                })
            else:
                # åˆ›å»ºæ–°æç¤ºè¯
                new_prompt = UserPrompt.objects.create(
                    user=request.user,
                    name=prompt_data['name'],
                    description=prompt_data['description'],
                    content=prompt_data['content'],
                    prompt_type=actual_prompt_type,
                    is_default=False,  # ç¨‹åºè°ƒç”¨ç±»åž‹ä¸èƒ½è®¾ä¸ºé»˜è®¤
                    is_active=True
                )
                serializer = self.get_serializer(new_prompt)
                created_prompts.append(serializer.data)

        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": f"åˆå§‹åŒ–å®Œæˆï¼åˆ›å»ºäº† {len(created_prompts)} ä¸ªæç¤ºè¯ï¼Œè·³è¿‡ {len(skipped_prompts)} ä¸ª",
            "data": {
                "created": created_prompts,
                "skipped": skipped_prompts,
                "summary": {
                    "created_count": len(created_prompts),
                    "skipped_count": len(skipped_prompts),
                    "total_types": len(default_prompts)
                }
            },
            "errors": {}
        })

    @action(detail=False, methods=['get'])
    def init_status(self, request):
        """èŽ·å–ç”¨æˆ·æç¤ºè¯åˆå§‹åŒ–çŠ¶æ€"""
        # èŽ·å–ç”¨æˆ·çŽ°æœ‰çš„æç¤ºè¯ç±»åž‹
        existing_types = set(UserPrompt.objects.filter(
            user=request.user
        ).values_list('prompt_type', flat=True))

        # æ‰€æœ‰å¯ç”¨çš„æç¤ºè¯ç±»åž‹
        all_types = dict(PromptType.choices)
        
        status_info = []
        for prompt_type, display_name in all_types.items():
            status_info.append({
                'type': prompt_type,
                'name': display_name,
                'exists': prompt_type in existing_types,
                'is_program_call': prompt_type in UserPrompt.PROGRAM_CALL_TYPES
            })

        missing_types = [
            info for info in status_info
            if not info['exists']
        ]

        return Response({
            "status": "success",
            "code": status.HTTP_200_OK,
            "message": "èŽ·å–åˆå§‹åŒ–çŠ¶æ€æˆåŠŸ",
            "data": {
                "all_types": status_info,
                "missing_types": missing_types,
                "summary": {
                    "total_types": len(all_types),
                    "existing_count": len(existing_types),
                    "missing_count": len(missing_types),
                    "can_initialize": len(missing_types) > 0
                }
            },
            "errors": {}
        })
